name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3

  notify-discord:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Get workflow run URL
        id: get-url
        run: |
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          # Get first line of commit message and escape for JSON
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Notify Discord on Success
        if: needs.build.result == 'success'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"âœ… ZMK Firmware Build Success!\",
                \"description\": \"ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã‚ˆã€œï¼\",
                \"color\": 5763719,
                \"fields\": [
                  {
                    \"name\": \"ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\",
                    \"value\": \"[ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã¡ã‚‰](${{ steps.get-url.outputs.run_url }}#artifacts)\"
                  },
                  {
                    \"name\": \"ğŸ”— è©³ç´°\",
                    \"value\": \"[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ](${{ steps.get-url.outputs.run_url }})\"
                  },
                  {
                    \"name\": \"ğŸ“ ã‚³ãƒŸãƒƒãƒˆ\",
                    \"value\": \"\`${{ github.sha }}\`\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ\",
                    \"value\": \"\`${{ github.ref_name }}\`\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",
                    \"value\": \"${{ steps.get-url.outputs.commit_msg }}\"
                  }
                ],
                \"footer\": {
                  \"text\": \"${{ github.repository }}\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            $DISCORD_WEBHOOK

      - name: Notify Discord on Failure
        if: needs.build.result == 'failure'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ ZMK Firmware Build Failed\",
                \"description\": \"ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸ...\",
                \"color\": 15548997,
                \"fields\": [
                  {
                    \"name\": \"ğŸ”— è©³ç´°\",
                    \"value\": \"[ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹](${{ steps.get-url.outputs.run_url }})\"
                  },
                  {
                    \"name\": \"ğŸ“ ã‚³ãƒŸãƒƒãƒˆ\",
                    \"value\": \"\`${{ github.sha }}\`\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ\",
                    \"value\": \"\`${{ github.ref_name }}\`\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸ’¬ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",
                    \"value\": \"${{ steps.get-url.outputs.commit_msg }}\"
                  }
                ],
                \"footer\": {
                  \"text\": \"${{ github.repository }}\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            $DISCORD_WEBHOOK