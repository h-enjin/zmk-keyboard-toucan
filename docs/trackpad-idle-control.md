# トラックパッド アイドル制御

## 概要

Cirque Pinnacleトラックパッドの省電力機能を実装。トラックパッド独自のタイムアウトとZMKのアクティビティ状態の両方に連動してアイドル化を行う。

## 動作原理

### 状態遷移図

```
                    ┌─────────────────────────────────────┐
                    │                                     │
                    ▼                                     │
┌──────────────────────────────────┐                      │
│      トラックパッド ACTIVE        │                      │
│  ・Feed有効                      │                      │
│  ・500ms毎にタッチ確認           │                      │
│  ・DR割り込みで入力処理          │                      │
└──────────────────────────────────┘                      │
         │                    │                           │
         │ タッチなし5秒経過  │ ZMKがIDLE/SLEEP           │
         │                    │                           │
         ▼                    ▼                           │
┌──────────────────────────────────┐                      │
│       トラックパッド IDLE         │                      │
│  ・Feed無効（省電力）            │                      │
│  ・50ms毎にポーリング            │──── タッチ検知 ───────┘
│  ・DR割り込みは発火しない        │
└──────────────────────────────────┘
```

### アイドル化の条件

トラックパッドは以下のいずれかの条件でアイドル状態になる：

1. **トラックパッド独自タイムアウト**: タッチなしで5秒経過
2. **ZMK連動**: ZMKがIDLEまたはSLEEP状態に移行

### 復帰の条件

- ポーリングによるタッチ検知で即座に復帰

## 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| `TRACKPAD_IDLE_TIMEOUT_MS` | 5000ms | タッチなしでアイドル化するまでの時間 |
| `TOUCH_POLL_INTERVAL_MS` | 50ms | アイドル時のポーリング間隔（復帰遅延に影響） |
| `ACTIVE_CHECK_INTERVAL_MS` | 500ms | アクティブ時のタッチ確認間隔 |

### パラメータの調整

```c
// drivers/input/zmk_pinnacle_idle_sleeper.c

// より早くアイドル化したい場合
#define TRACKPAD_IDLE_TIMEOUT_MS 3000  // 3秒

// より早い復帰が必要な場合（電力消費増）
#define TOUCH_POLL_INTERVAL_MS 25  // 25ms

// より省電力にしたい場合（復帰遅延増）
#define TOUCH_POLL_INTERVAL_MS 100  // 100ms
```

## 電力消費

### 各状態の消費電力（推定）

| 状態 | トラックパッド消費電流 | 備考 |
|------|----------------------|------|
| ACTIVE | ~2.9mA | フル動作 |
| IDLE（ポーリング中） | ~数百µA + ポーリング分 | Feed無効、定期的にSPI通信 |
| チップ内蔵スリープ | ~数µA | 未使用（復帰遅延のため） |

### 使用パターン別の効果

| シナリオ | 従来実装 | 新実装 |
|---------|---------|--------|
| タイピング中（トラックパッド未使用） | ACTIVE（無駄な消費） | **5秒後にIDLE** |
| トラックパッド使用中 | ACTIVE | ACTIVE |
| キーボード全体が30秒放置 | IDLE | IDLE |
| トラックパッドのみ5秒放置 | ACTIVE | **IDLE** |

## 技術詳細

### Feed-disable方式

チップの完全スリープではなく、データ出力（Feed）のみを無効化する方式を採用。

**メリット:**
- 即座の復帰が可能（再キャリブレーション不要）
- 安定した動作

**デメリット:**
- チップ内蔵スリープより消費電力が高い

### ポーリング方式

Feed無効時はDR（Data Ready）割り込みが発火しないため、定期的にタッチを確認する。

```
[ポーリング処理の流れ]
1. Feed有効化
2. 100µs待機
3. STATUS1レジスタのSW_DRビット確認
4. タッチあり → 復帰処理
   タッチなし → Feed無効化、次のポーリングをスケジュール
```

### 関連ファイル

| ファイル | 役割 |
|---------|------|
| `drivers/input/zmk_pinnacle_idle_sleeper.c` | アイドル制御ロジック |
| `drivers/input/input_pinnacle.c` | ドライバ本体、Feed制御関数 |
| `drivers/input/input_pinnacle.h` | 関数宣言 |
| `boards/shields/toucan/toucan_right.overlay` | デバイスツリー設定 |
| `boards/shields/toucan/toucan.conf` | 機能有効化設定 |

### 有効化設定

```conf
# boards/shields/toucan/toucan.conf
CONFIG_ZMK_INPUT_PINNACLE_IDLE_SLEEPER=y
```

### デバイスツリー設定

```dts
// boards/shields/toucan/toucan_right.overlay
glidepoint: glidepoint@0 {
    compatible = "cirque,pinnacle";
    // ...
    /* sleep; */  /* チップ内蔵スリープは無効化 */
};
```

## トラブルシューティング

### トラックパッドが復帰しない

- ポーリング間隔を短くする（`TOUCH_POLL_INTERVAL_MS`）
- ログを有効化して状態を確認

### 復帰時に遅延を感じる

- `TOUCH_POLL_INTERVAL_MS` を小さくする（例: 25ms）
- ただし電力消費は増加

### バッテリー消費が大きい

- `TRACKPAD_IDLE_TIMEOUT_MS` を短くする（例: 3000ms）
- `TOUCH_POLL_INTERVAL_MS` を長くする（例: 100ms）

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-10 | トラックパッド独立アイドル制御を実装 |
| 2026-01-10 | チップ内蔵スリープを無効化（安定性向上） |
| 2026-01-10 | Discord通知にコミットメッセージ追加 |
